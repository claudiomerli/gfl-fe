<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <div class="row">
    <div class="col-3">
      <mat-form-field class="w-100">
        <mat-label>Nome del progetto</mat-label>
        <input matInput type="text" formControlName="name">
        <mat-error *ngIf="form.controls.name.invalid">Campo non valido</mat-error>
      </mat-form-field>
    </div>
    <div class="col-3">
      <mat-form-field *isAuthenticated="['ADMIN', 'CHIEF_EDITOR']" class="w-100">
        <mat-label>Cliente</mat-label>
        <input matInput type="text" (keyup)="loadCustomer($event)" [matAutocomplete]="auto" #customerAutoComplete>
        <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayCustomerFn"
                          (optionSelected)="optionSelectedCustomer($event)">
          <mat-option *ngFor="let customerEntry of customerList" [value]="customerEntry">
            {{customerEntry!.name}}
          </mat-option>
        </mat-autocomplete>
        <mat-error *ngIf="form.controls.name.invalid">Campo non valido</mat-error>
      </mat-form-field>
      <mat-form-field *isAuthenticated="['CUSTOMER']" class="w-100">
        <mat-label>Cliente</mat-label>
        <input matInput type="text" value="{{getCurrentCustomer()}}" readonly>
      </mat-form-field>
    </div>
    <div class="col-3" *ngIf="isEdit">
      <mat-form-field class="w-100">
        <mat-label>Stato</mat-label>
        <input matInput type="text" class="form-control" id="status" [value]="project?.status" readonly>
        <button matSuffix mat-icon-button *ngIf="isEdit && project?.nextState" type="button"
                (click)="changeStatus.emit(project)" title="Cambia stato">
          <mat-icon>change_circle</mat-icon>
        </button>
      </mat-form-field>
    </div>
  </div>

  <button mat-raised-button type="button" (click)="plus()" title="Aggiungi Articolo">
    <mat-icon>add</mat-icon>
    Aggiungi articolo
  </button>

  <div class="p-3">
    <ng-container formArrayName="projectContentPreviews" *ngFor="let projectContentPreview of controls; let i = index;">
      <mat-card [formGroupName]="i">
        <mat-card-content>
          <h2 class="accordion-header" id="heading{{i}}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                    [attr.data-bs-target]="'#collapse'+i" aria-expanded="false"
                    [attr.aria-controls]="'collapse'+i">
              {{projectContentPreview.value.title || 'Articolo #' + (i + 1)}}
            </button>
          </h2>
          <div id="collapse{{i}}" class="accordion-collapse collapse" [attr.aria-labelledby]="'heading'+i"
               data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <div class="row">
                <div class="col">
                  <div class="mb-3 input-group">
                    <label for="newspaper{{i}}" class="input-group-text">
                      <i class="bi bi-newspaper mx-auto mb-1"></i>
                    </label>
                    <select formControlName="newspaperId" id="newspaper{{i}}" class="form-select"
                            [validationMessage]="formSubmitted">
                      <option value="''">-- Seleziona una testata --</option>
                      <option *ngFor="let newspaper of newspaperList"
                              value="{{newspaper?.id}}">{{newspaper?.name}}</option>
                    </select>
                  </div>
                </div>
                <div class="col">
                  <div class="mb-3 input-group">
                    <label class="input-group-text" for="monthUse{{i}}">
                      <i class="bi bi-calendar-month"></i>
                    </label>
                    <select class="form-select" id="monthUse{{i}}" formControlName="monthUse"
                            [validationMessage]="formSubmitted">
                      <option [ngValue]="''">-- Seleziona un mese --</option>
                      <option [ngValue]="'JANUARY'">Gennaio</option>
                      <option [ngValue]="'FEBRUARY'">Febbraio</option>
                      <option [ngValue]="'MARCH'">Marzo</option>
                      <option [ngValue]="'APRIL'">Aprile</option>
                      <option [ngValue]="'MAY'">Maggio</option>
                      <option [ngValue]="'JUNE'">Giugno</option>
                      <option [ngValue]="'JULY'">Luglio</option>
                      <option [ngValue]="'AUGUST'">Agosto</option>
                      <option [ngValue]="'SEPTEMBER'">Settembre</option>
                      <option [ngValue]="'OCTOBER'">Ottobre</option>
                      <option [ngValue]="'NOVEMBER'">Novembre</option>
                      <option [ngValue]="'DECEMBER'">Dicembre</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <div class="mb-3">
                    <label for="anchor{{i}}" class="form-label">Url</label>
                    <div class="input-group">
                      <div class="input-group-text">
                        <i class="bi bi-link"></i>
                      </div>
                      <input type="text" class="form-control" id="anchor{{i}}" formControlName="linkUrl"
                             [validationMessage]="formSubmitted">
                    </div>
                  </div>
                </div>
                <div class="col">
                  <div class="mb-3">
                    <label for="url{{i}}" class="form-label">Testo link</label>
                    <div class="input-group">
                      <div class="input-group-text">
                        <i class="bi bi-link-45deg"></i>
                      </div>
                      <input type="text" class="form-control" id="url{{i}}" formControlName="linkText"
                             [validationMessage]="formSubmitted">
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <div class="mb-3">
                    <label for="title{{i}}" class="form-label">Titolo</label>
                    <div class="input-group">
                      <div class="input-group-text">
                        <i class="bi bi-fonts"></i>
                      </div>
                      <input type="text" class="form-control" id="title{{i}}" formControlName="title"
                             [validationMessage]="formSubmitted">
                    </div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <div class="mb-3">
                    <label for="note{{i}}" class="form-label">Note del cliente</label>
                    <div class="input-group">
                      <div class="input-group-text">
                        <i class="bi bi-chat-left-text"></i>
                      </div>
                      <textarea id="note{{i}}" class="form-control" aria-label="note del cliente"
                                formControlName="customerNotes" [validationMessage]="formSubmitted"></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
        <mat-card-actions>
          <ng-container *ngIf="projectContentPreview.value.id">
            <button mat-raised-button *isAuthenticated="['ADMIN']" type="button" title="Assegna contenuto"
                    (click)="gestisciRedazionale(projectContentPreview.value)">
              <mat-icon>history_edu</mat-icon>
              Gestisci redazionale
            </button>
          </ng-container>

          <button color="accent" mat-raised-button type="button" class="btn btn-danger" (click)="minus(i)"
                  title="Elimina Articolo {{i+1}}"
                  [disabled]="projectContentPreview.value.contentId">
            <mat-icon>remove</mat-icon>
            Rimuovi
          </button>
        </mat-card-actions>
      </mat-card>
    </ng-container>
  </div>

  <button type="submit" class="btn btn-primary">
    <i class="bi bi-save"></i>
    Salva
  </button>

  <a *ngIf="isEdit" class="btn btn-success ms-3" [routerLink]="'/contents'" [queryParams]="{projectId: project?.id}">
    Vai agli articoli
  </a>
</form>
